name: Noalbs Linux Builder
on:
  workflow_dispatch:
    inputs:
      noalbs_tag:
        description: 'Noalbs Tag (z.B. v2.16.0)'
        required: true
        default: 'v2.16.0'
        type: string

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target: [amd64, i386, arm64, armv7, ppc64le, s390x, riscv64]
        include:
          - target: amd64
            platform: linux/amd64
            archive: noalbs-linux-amd64.tar.gz
          - target: i386
            platform: linux/386
            archive: noalbs-linux-i386.tar.gz
          - target: arm64
            platform: linux/arm64
            archive: noalbs-linux-arm64.tar.gz
          - target: armv7
            platform: linux/arm/v7
            archive: noalbs-linux-armv7.tar.gz
          - target: ppc64le
            platform: linux/ppc64le
            archive: noalbs-linux-ppc64le.tar.gz
          - target: s390x
            platform: linux/s390x
            archive: noalbs-linux-s390x.tar.gz
          - target: riscv64
            platform: linux/riscv64
            archive: noalbs-linux-riscv64.tar.gz

    steps:
    - uses: actions/checkout@v4
    
    - name: Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build ${{ matrix.target }}
      uses: docker/build-push-action@v6
      with:
        context: .
        load: true
        platforms: ${{ matrix.platform }}
        tags: noalbs-${{ matrix.target }}
        build-args: |
          NOALBS_TAG=${{ github.event.inputs.noalbs_tag }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Extract Paket
      run: |
        docker create --name temp noalbs-${{ matrix.target }}
        docker cp temp:/noalbs/target/*/*/release/noalbs ./noalbs
        docker cp temp:/noalbs/config.json ./config.json
        docker cp temp:/noalbs/.env ./.env || echo "PORT=8080" > .env
        docker rm temp
        tar -czf ${{ matrix.archive }} noalbs config.json .env
        sha256sum ${{ matrix.archive }} > ${{ matrix.archive }}.sha256
        
    - uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.archive }}
        path: |
          ${{ matrix.archive }}
          ${{ matrix.archive }}.sha256

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/download-artifact@v4
      with:
        path: ./releases
        
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.event.inputs.noalbs_tag }}
        name: "NOALBS ${{ github.event.inputs.noalbs_tag }} - Linux"
        body: |
          # NOALBS ${{ github.event.inputs.noalbs_tag }} Linux Builds
          
          **Source**: https://github.com/NOALBS/nginx-obs-automatic-low-bitrate-switching/tree/${{ github.event.inputs.noalbs_tag }}
          
          | Arch          | Download |
          |---------------|----------|
          | x86_64        | [noalbs-linux-amd64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.noalbs_tag }}/noalbs-linux-amd64.tar.gz) |
          | i686          | [noalbs-linux-i386.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.noalbs_tag }}/noalbs-linux-i386.tar.gz) |
          | ARM64         | [noalbs-linux-arm64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.noalbs_tag }}/noalbs-linux-arm64.tar.gz) |
          | ARMv7         | [noalbs-linux-armv7.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.noalbs_tag }}/noalbs-linux-armv7.tar.gz) |
          | RISC-V        | [noalbs-linux-riscv64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.noalbs_tag }}/noalbs-linux-riscv64.tar.gz) |
          | PowerPC       | [noalbs-linux-ppc64le.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.noalbs_tag }}/noalbs-linux-ppc64le.tar.gz) |
          | s390x         | [noalbs-linux-s390x.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.noalbs_tag }}/noalbs-linux-s390x.tar.gz) |
          
          **[All Downloads](https://github.com/${{ github.repository }}/releases/tag/${{ github.event.inputs.noalbs_tag }})**
        draft: false
        prerelease: false
        files: |
          releases/noalbs-linux-*/noalbs-linux-*.tar.gz
          releases/noalbs-linux-*/noalbs-linux-*.tar.gz.sha256
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

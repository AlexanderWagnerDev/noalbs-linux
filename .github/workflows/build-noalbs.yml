name: Noalbs Linux Builder

on:
  workflow_dispatch:
    inputs:
      noalbs_tag:
        description: 'Noalbs Tag (z.B. v2.16.0)'
        required: true
        default: 'v2.16.0'
        type: string
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - target: amd64
            platform: linux/amd64
          - target: i386
            platform: linux/386
          - target: arm64
            platform: linux/arm64
          - target: armv7
            platform: linux/arm/v7
          - target: armv6
            platform: linux/arm/v6
          - target: ppc64le
            platform: linux/ppc64le
          - target: s390x
            platform: linux/s390x
          - target: riscv64
            platform: linux/riscv64

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build ${{ matrix.target }}
      uses: docker/build-push-action@v6
      with:
        context: .
        load: true
        platforms: ${{ matrix.platform }}
        tags: noalbs-builder-${{ matrix.target }}
        build-args: |
          NOALBS_TAG=${{ github.event.inputs.noalbs_tag || github.ref_name }}
        cache-from: type=gha,scope=build-${{ matrix.target }}
        cache-to: type=gha,mode=max,scope=build-${{ matrix.target }}
        
    - name: Extract Paket
      run: |
        docker create --name temp-${{ matrix.target }} noalbs-builder-${{ matrix.target }}
        docker cp temp-${{ matrix.target }}:/app/nginx-obs-automatic-low-bitrate-switching/target/release/noalbs ./noalbs
        docker cp temp-${{ matrix.target }}:/app/nginx-obs-automatic-low-bitrate-switching/config.json ./config.json
        docker cp temp-${{ matrix.target }}:/app/nginx-obs-automatic-low-bitrate-switching/.env ./.env
        docker rm temp-${{ matrix.target }}
        tar -czf noalbs-linux-${{ matrix.target }}.tar.gz noalbs config.json .env
        sha256sum noalbs-linux-${{ matrix.target }}.tar.gz > noalbs-linux-${{ matrix.target }}.tar.gz.sha256
        
    - uses: actions/upload-artifact@v4
      with:
        name: noalbs-linux-${{ matrix.target }}
        path: |
          noalbs-linux-${{ matrix.target }}.tar.gz
          noalbs-linux-${{ matrix.target }}.tar.gz.sha256

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/download-artifact@v4
      with:
        path: ./releases
        
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.event.inputs.noalbs_tag }}
        name: "NOALBS ${{ github.event.inputs.noalbs_tag }} - Linux"
        body: |
          # NOALBS ${{ github.event.inputs.noalbs_tag }} Linux Builds
          
          **Source**: https://github.com/NOALBS/nginx-obs-automatic-low-bitrate-switching/tree/${{ github.event.inputs.noalbs_tag }}
          
          | Arch          | Download |
          |---------------|----------|
          | x86_64        | [noalbs-linux-amd64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.noalbs_tag }}/noalbs-linux-amd64.tar.gz) |
          | i386          | [noalbs-linux-i386.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.noalbs_tag }}/noalbs-linux-i386.tar.gz) |
          | ARM64         | [noalbs-linux-arm64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.noalbs_tag }}/noalbs-linux-arm64.tar.gz) |
          | ARMv7         | [noalbs-linux-armv7.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.noalbs_tag }}/noalbs-linux-armv7.tar.gz) |
          | ARMv6         | [noalbs-linux-armv6.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.noalbs_tag }}/noalbs-linux-armv6.tar.gz) |
          | RISC-V        | [noalbs-linux-riscv64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.noalbs_tag }}/noalbs-linux-riscv64.tar.gz) |
          | PowerPC       | [noalbs-linux-ppc64le.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.noalbs_tag }}/noalbs-linux-ppc64le.tar.gz) |
          | s390x         | [noalbs-linux-s390x.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.noalbs_tag }}/noalbs-linux-s390x.tar.gz) |
          
          **[All Downloads](https://github.com/${{ github.repository }}/releases/tag/${{ github.event.inputs.noalbs_tag }})**
        draft: false
        prerelease: false
        files: |
          releases/noalbs-linux-*/noalbs-linux-*.tar.gz
          releases/noalbs-linux-*/noalbs-linux-*.tar.gz.sha256
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
